<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Parks</title>
  <!-- css link  -->
  <link rel="stylesheet" href="css/style.css" />
  <!-- font awesome  -->

  <link rel="shortcut icon" href="./assets/images/logo.png" type="image/svg+xml" />

  <!-- 
  - custom css link
-->
  <link rel="stylesheet" href="./assets/css/style.css" />

  <!-- font awesome  -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />


  <!-- Include SweetAlert2 CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <!-- Include SweetAlert2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- 
  - google font link
-->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&family=Poppins:wght@400;500;600;700&display=swap"
    rel="stylesheet" />

  <link rel="stylesheet" href="css/main.css">

  <style>

  </style>
</head>

<body>

  <aside class="sidebar " id="sidebar">
    <header>
      <div class="image-text">
        <span class="image">
          <img src="img/logo.png" alt="" />
        </span>
  
        <div class="text header-text">
  
        </div>
      </div>
  
      <i class="fa-solid fa-angle-right toggle" id="close-toggle" onclick="closeBtn() "></i>
    </header>
  
    <div class="menu-bar">
      <div class="menu">
        <ul class="menu-links">
          <li class="navlink">
            <input type="search" name="" id="" placeholder=" search" />
            <a href="#" title="search">
              <i class="fa-solid fa-magnifying-glass search"></i>
            </a>
          </li>
          <li class="navlink">
            <a href="index.html" >
              <i class="fa-solid fa-house icon"></i>
              <span class="text nav-text">Dashboard</span>
            </a>
          </li>
          <li class="navlink">
            <a href="user.html">
              <i class="fa-solid fa-users-line icon"></i>
              <span class="text nav-text">users</span>
            </a>
          </li>
          <li class="navlink">
            <a href="vic.html">
             <i class="fa-solid fa-car icon"></i>
              <span class="text nav-text">vehicles</span>
            </a>
          </li>
          <li class="navlink">
            <a href="parks.html" class="active">
            <i class="fa-solid fa-square-parking icon"></i>
              <span class="text nav-text">parks</span>
            </a>
          </li>
          <li class="navlink">
            <a href="services.html">
              <i class="fa-solid fa-gears icon"></i>
              <span class="text nav-text">Services</span>
            </a>
          </li>
          <li class="navlink">
            <a href="banners.html">
              <i class="fa-regular fa-images icon"></i>
              <span class="text nav-text">Banners</span>
            </a>
          </li>
          <li class="navlink">
            <a href="event.html">
             <i class="fa-solid fa-calendar-minus icon"></i>
              <span class="text nav-text">Event</span>
            </a>
          </li>
          <li class="navlink">
            <a href="payment.html">
              <i class="fa-solid fa-sack-xmark icon"></i>
              <span class="text nav-text">Payment</span>
            </a>
          </li>
          <li class="navlink">
            <a href="orders.html">
              <i class="fa-regular fa-folder-open icon"></i>
              <span class="text nav-text">Orders</span>
            </a>
          </li>
          <li class="navlink">
            <a href="acount.html">
              <i class="fa-solid fa-user-pen icon"></i>
              <span class="text nav-text">Acount</span>
            </a>
          </li>
          <li class="navlink">
            <a href="#">
              <i class="fa-solid fa-right-from-bracket icon"></i>
              <span class="text nav-text" onclick="deleteTokenAndConfirm()">Logout</span>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </aside>

  <section class="head">
    <ul>
      <li><i class="fa-solid fa-bell icon"></i></li>
      <li><img src="img/prof1.png" alt="" /></li>
    </ul>
  </section>


  <section class="main">

    <section class="parks">
      <div class="container">
        <h1>Parks</h1>
        <div class="grid-boxes">
        </div>
      </div>
    </section>

    <section class="add-park">
      <div class="container">
        <h3>add park</h3>
        <a href="#" class="btn" onclick="addPark()">add park</a>
        <!-- <a href="#" class="btn" onclick="findNearestParking()">n park</a> -->
      </div>
    </section>
    <section class="deletall">
      <div class="container">
        <h3>delete all parks</h3>

        <a href="#" class="btn" onclick="deleteAllParks()">delet all parks</a>
      </div>
    </section>


    <section class="add">
      <div class="fas fa-times" id="close-btn-add" onclick="closeBtnAdd()"></div>
      <form id="addParkingForm">
        <label for="parking_name">Park Name:</label>
        <input type="text" id="parking_name" name="parking_name" />
        <label for="city">City:</label>
        <input type="text" id="city" name="city" />
        <label for="state">State:</label>
        <input type="text" id="state" name="state" />
        <label for="address">Address:</label>
        <input type="text" id="address" name="address" />
        <label for="totalPlace">Total Places</label>
        <input type="number" id="totalPlace" name="totalPlace" />
        <label for="creditPointPerHour">credit Point Per Hour</label>
        <input type="number" id="creditPointPerHour" name="creditPointPerHour" />
        <label for="locationMap">خريطة الموقع:</label>
        <input type="text" id="locationMap" name="locationMap" />
        <label for="creditPointPerMonth">نقاط الائتمان في الشهر:</label>
        <input type="number" id="creditPointPerMonth" name="creditPointPerMonth" />
        <input type="submit" value="إضافة جراج" />
      </form>
    </section>

    <section class="edit">
      <div class="fas fa-times" id="close-btn" onclick="closeBtnUpd()"></div>
      <form id="editParkingForm">
        <label for="parking_nameEdit">Park Name:</label>
        <input type="text" id="parking_nameEdit" name="parking_name" />
        <label for="cityEdit">City:</label>
        <input type="text" id="cityEdit" name="city" />
        <label for="stateEdit">State:</label>
        <input type="text" id="stateEdit" name="state" />
        <label for="addressEdit">Address:</label>
        <input type="text" id="addressEdit" name="address" />
        <label for="totalPlaceEdit">Total Places</label>
        <input type="number" id="totalPlaceEdit" name="totalPlace" />
        <label for="creditPointPerHourEdit">credit Point Per Hour</label>
        <input type="number" id="creditPointPerHourEdit" name="creditPointPerHour" />
        <label for="locationMapEdit">خريطة الموقع:</label>
        <input type="text" id="locationMapEdit" name="locationMap" />
        <label for="creditPointPerMonthEdit">نقاط الائتمان في الشهر:</label>
        <input type="number" id="creditPointPerMonthEdit" name="creditPointPerMonth" />
        <input type="submit" value="تعديل" />
      </form>
    </section>

    <div class="box-wallet"></div>



    </article>
    </main>



    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="js/main.js"></script>

    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <script>

      function closeBtnUpd() {

        var element = document.querySelector(".edit");
        element.classList.remove("show");


      }


      function closeBtnAdd() {
        let element = document.querySelector(".add");
        element.classList.remove("show");
      }

      // let closeToggle = document.getElementById("close-toggle");
      // let sidebar = document.getElementById("sidebar");

      // closeToggle.onclick = function () {
      //   if (sidebar.classList.contains("close")) {
      //     sidebar.classList.remove("close");
      //   } else {
      //     sidebar.classList.add("close");
      //   }
      // };




      // allWallet();
      // const token = JSON.parse(localStorage.getItem("token"));

      function ParkingData() {
        function getStars(rating) {
          // تحويل التقييم إلى عدد صحيح
          rating = Math.round(rating);

          let stars = "";
          // إضافة نجمة صلبة لكل نقطة تقييم
          for (let i = 0; i < rating; i++) {
            stars += '<i class="fas fa-star y-star"></i>';
          }
          // إضافة نجمة فارغة للنقاط المتبقية
          for (let i = 0; i < 5 - rating; i++) {
            stars += '<i class="far fa-star d-star"></i>';
          }
          return stars;
        }
        const gridBoxes = document.querySelector(".grid-boxes");

        fetch(`${api}/api/v1/parking`, {
          method: "GET",
          headers: {
            token: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY2NDI3ZDk3ZTNjOWRlYTRhYzBjNzZiOSIsImVtYWlsIjoidmlwdGUzb0BnbWFpbC5jb20iLCJ1c2VyTmFtZSI6ImFobWVkIGtpbGFueSIsImNyZWF0ZWRBdCI6IjIwMjQtMDUtMTNUMjA6NTI6MzkuNTgzWiIsInJvbGUiOiJzdXBlckFkbWluIiwiaWF0IjoxNzE2OTEyNjY4LCJleHAiOjE3MTc2OTAyNjh9.zINVe4ZSBp0Hh6VRj-fdCCubQWCmWC5dnk9tnucDCGI`,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            console.log(data);
            for (let i = 0; i < data.data.length; i++) {
              const parking = data.data[i];

              const box = document.createElement("div");
              box.className = "box";

              box.innerHTML = `
            <img src="https://i.ibb.co/kx7BNHB/service-1.png" alt="">
  <h3 class="parkName">${parking.parking_name}</h3>
  <p class="location"><span class="city">${parking.location.city}</span>${parking.location.address
                }</p>
  <p class="cridPrice"> ${parking.creditPointPerHour
                } <span class="crid">credit point per hour</span></p>
  <p class="cridPrice"> ${parking.creditPointPerMonth
                } <span class="crid">credit point per month</span></p>
  <p class="rating">${getStars(parking.rate)} <span class="crid"></span></p>
  <p class="cridPrice"> ${parking.remainingSpace
                } <span class="crid">remaining Space</span></p>
                <div class="btns">
                  <a href="#" class="btn" onclick="editPark('${parking._id}')">edit</a>
                  <a href="#" class="btn" onclick="deletePark('${parking._id}')">delete</a>
                </div>
              `;

              gridBoxes.appendChild(box);
            }
          })
          .catch((error) => console.error("Error:", error));
      }



      function addPark() {

        var element = document.querySelector('.add');

        element.classList.add('show');


        document
          .getElementById("addParkingForm")
          .addEventListener("submit", function (event) {
            event.preventDefault();

            let locationMapValue = document.getElementById("locationMap").value;
            let locationMapObject = {};
            try {
              locationMapObject = JSON.parse(locationMapValue);
            } catch (error) {
              console.error("Parsing error:", error);
            }

            let data = {
              parking_name: document.getElementById("parking_name").value,
              city: document.getElementById("city").value,
              state: document.getElementById("state").value,
              address: document.getElementById("address").value,
              totalPlace: document.getElementById("totalPlace").value,
              creditPointPerHour:
                document.getElementById("creditPointPerHour").value,
              locationMap: locationMapObject, // استخدام الكائن هنا
              creditPointPerMonth: document.getElementById(
                "creditPointPerMonth"
              ).value,
            };

            fetch(`${api}/api/v1/parking`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                token: token,
              },
              body: JSON.stringify(data),
            })
              .then((response) => response.json())
              .then((data) => {
                console.log(data);
                document.getElementById("parking_name").value = "";
                document.getElementById("city").value = "";
                document.getElementById("state").value = "";
                document.getElementById("address").value = "";
                document.getElementById("totalPlace").value = "";
                document.getElementById("creditPointPerHour").value = "";
                document.getElementById("locationMap").value = "";
                document.getElementById("creditPointPerMonth").value = "";

                swal({
                  title: "done!",
                  text: "park add successfully",
                  icon: "success",
                  buttons: {
                    confirm: {
                      text: "ok",
                      value: true,
                      visible: true,
                      closeModal: true,
                    },
                  },
                  closeOnClickOutside: false,
                }).then((value) => {
                  location.reload();
                });
              })
              .catch((error) => {
                console.error("Error:", error);
                swal({
                  title: "error!",
                  text: "park not add successfully",
                  icon: "error",
                  buttons: {
                    confirm: {
                      text: "ok",
                      value: true,
                      visible: true,
                      closeModal: true,
                    },
                  },
                  closeOnClickOutside: false,
                });
              });
          });
      }

      function fillForm(id) {
        fetch(`${api}/api/v1/parking/${id}`, {
          method: "GET",
          headers: {
            token: token,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            const parking = data.data;
            document.getElementById("parking_nameEdit").value = parking.parking_name;
            document.getElementById("cityEdit").value = parking.location.city;
            document.getElementById("stateEdit").value = parking.location.state;
            document.getElementById("addressEdit").value = parking.location.address;
            document.getElementById("totalPlaceEdit").value = parking.totalPlace;
            document.getElementById("creditPointPerHourEdit").value = parking.creditPointPerHour;
            document.getElementById("locationMapEdit").value = JSON.stringify(parking.locationMap);
            document.getElementById("creditPointPerMonthEdit").value = parking.creditPointPerMonth;
          })
          .catch((error) => console.error("Error:", error));
      }

      function editPark(id) {
        fillForm(id);

        var element = document.querySelector('.edit');

        element.classList.add('show');

        document
          .getElementById("editParkingForm")
          .addEventListener("submit", function (event) {
            event.preventDefault();

            let locationMapValue = document.getElementById("locationMapEdit").value;
            let locationMapObject = {};
            try {
              locationMapObject = JSON.parse(locationMapValue);
            } catch (error) {
              console.error("Parsing error:", error);
            }

            let data = {
              parking_name: document.getElementById("parking_nameEdit").value,
              city: document.getElementById("cityEdit").value,
              state: document.getElementById("stateEdit").value,
              address: document.getElementById("addressEdit").value,
              totalPlace: document.getElementById("totalPlaceEdit").value,
              creditPointPerHour:
                document.getElementById("creditPointPerHourEdit").value,
              locationMap: locationMapObject, // استخدام الكائن هنا
              creditPointPerMonth: document.getElementById(
                "creditPointPerMonthEdit"
              ).value,
            };

            fetch(`${api}/api/v1/parking/${id}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                token: token,
              },
              body: JSON.stringify(data),
            })
              .then((response) => response.json())
              .then((data) => {
                console.log(data);
                swal("تم!", "تم تعديل الجراج بنجاح", "success");
                // location.reload();
              })
              .catch((error) => {
                console.error("Error:", error);
                swal("خطأ!", "حدث خطأ أثناء تعديل الجراج", "error");
              });
          });
      }

      function deletePark(id) {
        swal({
          title: "are you sure ?",
          text: "you can't restore data , contenu ?",
          icon: "warning",
          buttons: ["No", "Yes"],
          dangerMode: true,
        }).then((willDelete) => {
          if (willDelete) {
            fetch(`${api}/api/v1/parking/${id}`, {
              method: "DELETE",
              headers: {
                token: token,
              },
            })
              .then((response) => {
                if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
              })
              .then((data) => {
                console.log(data);
                swal("Done!", "park deleted", "success");
                location.reload();
              })
              .catch((error) => {
                console.error("Error:", error);
                swal("error!", "can't delete the park", "error");
              });
          } else {
            swal("cancelled");
          }
        });
      }





      ParkingData();














      // function findNearestParking(longitude, latitude) {
      //   fetch('http://localhost:3000/api/v1/parking/location', {
      //     method: 'POST',
      //     headers: {
      //       'Content-Type': 'application/json',
      //     },
      //     body: JSON.stringify({
      //       "locationMap": {
      //         "type": "Point",
      //         "coordinates": [longitude, latitude]
      //       }
      //     }),
      //   })
      //     .then(response => response.json())
      //     .then(data => {
      //       if (data.success && data.data.length > 0) {
      //         console.log("أقرب جراج هو: ", data.data[0]);
      //       } else {
      //         console.log("لم يتم العثور على جراجات قريبة");
      //       }
      //     })
      //     .catch((error) => {
      //       console.error('Error:', error);
      //     });
      // }






    </script>

</body>

</html>